<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>IntentCP Panel ¬∑ Devices</title>
    <link rel="stylesheet" href="/static/panel.css" />
  </head>
  <body>
    <div class="layout">
      <aside class="sidebar">
        <div class="brand">
          <div class="brand__logo">üè†</div>
          <div class="brand__text">
            <div class="brand__title">IntentCP</div>
            <div class="brand__sub">Core Panel</div>
          </div>
        </div>

        <nav class="nav">
          <a class="nav__item" href="/panel/">Overview</a>
          <a class="nav__item nav__item--active" href="/panel/devices">Devices</a>
          <a class="nav__item" href="/panel/settings">Settings</a>
          <a class="nav__item" href="/docs">API Docs</a>
        </nav>

        <div class="sidebar__footer">
          <div class="kv"><span class="k">File</span><span class="v">{{ path }}</span></div>
        </div>
      </aside>

      <main class="main">
        <header class="topbar">
          <div>
            <h1 class="h1">Devices</h1>
            <div class="muted">Test actions quickly and keep TOML as source of truth.</div>
          </div>
          <div class="topbar__right">
            <span class="badge" id="healthBadge">checking‚Ä¶</span>
            <button id="themeToggle" type="button" class="btn small">üñ•Ô∏è Auto</button>
            <a class="btn" href="/panel/devices">Reload</a>
          </div>
        </header>

        <section class="card">
          <div class="card__title">Registered devices</div>
          {% if device_names and device_names|length > 0 %}
            <div class="table-wrap">
              <table class="table">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>IDs / metadata</th>
                    <th>Quick actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for name in device_names %}
                    {% set d = devices.get(name, {}) %}
                    <tr>
                      <td><code>{{ name }}</code></td>
                      <td class="muted">
                        {% if d and d.items %}
                          {% for k, v in d.items() %}
                            <div><code>{{ k }}</code>: <span class="muted">{{ v }}</span></div>
                          {% endfor %}
                        {% else %}
                          <div class="muted">(no fields)</div>
                        {% endif %}
                      </td>
                      <td>
                        <div class="actions actions--compact">
                          <button type="button" class="btn" data-action="tuya" data-device="{{ name }}" data-cmd="on">On</button>
                          <button type="button" class="btn" data-action="tuya" data-device="{{ name }}" data-cmd="off">Off</button>
                          <button type="button" class="btn" data-action="tuya" data-device="{{ name }}" data-cmd="toggle">Toggle</button>
                        </div>
                        <div class="muted" style="margin-top:6px;">
                          <div class="result-label">Result</div>
                          <pre class="result" id="res-{{ name }}">-</pre>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <p class="muted">No devices found under <code>[devices.*]</code>.</p>
          {% endif %}
        </section>

        <section class="card" style="margin-top:14px;">
          <div class="row">
            <div>
              <div class="card__title">Edit devices.toml</div>
              <div class="muted">Raw editor (validated as TOML before save).</div>
            </div>
            <button class="btn" id="btnFormatHint" type="button">Show example</button>
          </div>

          <form method="post" action="/panel/devices" style="margin-top:12px;">
            <textarea name="toml_text" class="textarea" spellcheck="false">{{ raw_toml }}</textarea>
            <div class="row" style="margin-top:10px;">
              <button class="btn primary" type="submit">Save</button>
              <a class="btn" href="/panel/devices">Reload</a>
            </div>
            <p class="muted" style="margin-top:10px;">
              Tip: split fingerbots are fine‚Äîstore separate <code>..._on</code>/<code>..._off</code> IDs. Your action router can decide which one to press.
            </p>
          </form>
        </section>
      </main>
    </div>

    <script src="/static/panel.js"></script>
    <script>
      // Page boot
      window.IntentCP && window.IntentCP.bootDevices && window.IntentCP.bootDevices();

      // Theme toggle: Auto -> Light -> Dark -> Auto
      (function () {
        const btn = document.getElementById('themeToggle');
        if (!btn) return;

        // prevent double-binding
        if (btn.dataset.initialized === '1') return;
        btn.dataset.initialized = '1';

        const STORAGE_KEY = 'homemcp_theme';

        const getSystemTheme = () =>
          window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
            ? 'dark'
            : 'light';

        const apply = (mode) => {
          // When auto, remove override so CSS @media(p prefers-color-scheme) can drive the theme
          if (mode === 'auto') {
            document.documentElement.removeAttribute('data-theme');
            return;
          }
          document.documentElement.setAttribute('data-theme', mode);
        };

        const label = (mode) =>
          mode === 'light' ? 'üîÜ Light'
          : mode === 'dark' ? 'üåô Dark'
          : 'üñ•Ô∏è Auto';

        const load = () => localStorage.getItem(STORAGE_KEY) || 'auto';
        const save = (mode) => localStorage.setItem(STORAGE_KEY, mode);

        const cycle = (mode) =>
          mode === 'auto' ? 'light'
          : mode === 'light' ? 'dark'
          : 'auto';

        let mode = load();
        apply(mode);
        btn.textContent = label(mode);

        btn.addEventListener('click', () => {
          mode = cycle(mode);
          save(mode);
          apply(mode);
          btn.textContent = label(mode);
        });

        // React to system theme changes when in Auto mode
        if (window.matchMedia) {
          const mq = window.matchMedia('(prefers-color-scheme: dark)');
          const onChange = () => {
            if (load() === 'auto') apply('auto');
          };
          if (typeof mq.addEventListener === 'function') {
            mq.addEventListener('change', onChange);
          } else if (typeof mq.addListener === 'function') {
            mq.addListener(onChange);
          }
        }
      })();
    </script>
  </body>
</html>